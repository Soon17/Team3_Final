<!DOCTYPE html>
<html
	lang="en" 
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
	layout:decorate="~{layout/layout.html}">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>예약내역</title>
	<style>
		.tab {
			width: 50%;
			text-align: center;
			padding: 10px 20px;
			color: #888;
			cursor: pointer;
		}
		.tab.active {
			color: #007bff;
			border-bottom: 2px solid #007bff;
		}
		.state-select{
			border: 1px solid #ced4da;
			border-radius: .5rem;
			padding: .5rem 1.5rem .5rem .75rem;
			appearance: none;
			-webkit-appearance: none;
			background: #fff url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTMiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMyAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Im05LjUgNC0zIDMtMy0zIiBzdHJva2U9IiM5OTkiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K) no-repeat center right .5rem;
		}
	</style>
</head>
<body>
	<main layout:fragment="content">
		<div style="width: 100%; border-top: 1px solid #eeeeee;"></div>
		<div class="main-text" style="text-align: center; padding: 2rem 0;">
			<h1 class="js-hero-pc-title" style="font-size: 24px; color: #333;">예약내역</h1>
		</div>
		<div style="width: 70%; margin: 20px auto; background-color: #fff; padding: 30px; border-radius: 8px; width: 768px;">
			<div id="tab-menu" style="display: flex; justify-content: center; margin-top: 20px; border-bottom: 2px solid #ddd;">
				<div class="tab" onclick="changeTab(this)">렌트카</div>
				<div class="tab active" onclick="changeTab(this)">호텔</div>
			</div>
			<select id="reservation-state" class="state-select" style="margin-top: 1rem; width: 100%; padding: .75rem; color: #494949; font-size: .875rem;" onchange="filterReservations()">
				<option value="전체">전체</option>
				<option value="예약완료">예약완료</option>
				<option value="취소/환불">취소/환불</option>
			</select>
		</div>
		<div>
			<div style="margin: .25rem 0 1rem; background-color: #f3f3f3; width: 100%; height: 1px;"></div>
        <div style="margin: 20px auto; width: 80%;">
					<div id="reservation-table">
            <table style="width: 100%; border-collapse: collapse; text-align: center;">
							<thead>
                <tr style="background-color: #f9f9f9;">
                    <th>예약 ID</th>
                    <th>예약 상태</th>
										<th>예약 숙소</th>
                    <th>대표 예약 옵션</th>
                    <th>체크인 - 체크아웃</th>
                    <th>예약자(인원)</th>
                    <th>대표 투숙자</th>
                    <th>판매 금액</th>
                    <th>입금 금액</th>
                    <th>예약 일시(KST)</th>
                </tr>
							</thead>
                <tbody id="reservation-list">
									<tr th:each="reservation : ${reservation}">
											<td th:text="${reservation.lr_me_name}"></td>
											<td th:text="${reservation.lr_state}"></td>
											<td th:text="${reservation.lr_ld_name}"></td>
											<td th:text="${reservation.lr_rm_name}"></td>
											<td th:text="${#dates.format(reservation.lr_checkin, 'yyyy-MM-dd') + ' - ' + #dates.format(reservation.lr_checkout, 'yyyy-MM-dd')}"></td>
											<td th:text="${reservation.lr_booker_name + '(' + reservation.lr_count + ')'}"></td>
											<td th:text="${reservation.lr_guest_name}"></td>
											<td th:text="${reservation.lr_total_price}"></td>
											<td th:text="${reservation.lr_total_price}"></td>
											<td th:text="${#dates.format(reservation.lr_date, 'yyyy-MM-dd HH:mm')}"></td>
									</tr>
							</tbody>
            </table>
					</div>
					<div id="no-reservation-message" style="display:none; text-align:center; padding:20px; font-weight:bold; color:#777;">
							렌트카 예약 내역이 없습니다.
					</div>
        </div>
    </div>
		<script>
			let activeTab = '호텔'; // 기본값을 호텔로 설정

			function changeTab(clickedTab) {
				const $tabs = $('.tab');
				$tabs.removeClass('active').css({ color: '#888', borderBottom: 'none' });
				$(clickedTab).addClass('active').css({ color: '#007bff', borderBottom: '2px solid #007bff' });

				activeTab = $(clickedTab).text();

				if (activeTab === '렌트카') {
						$('#reservation-table').hide(); // 테이블 전체 숨기기 (헤더 포함)
						$('#reservation-state').hide(); // 필터 숨기기
						$('#no-reservation-message').show(); // '예약 내역 없음' 메시지 보여주기
				} else {
						$('#reservation-table').show(); // 테이블 보이기
						$('#reservation-state').show(); // 필터 보이기
						$('#no-reservation-message').hide(); // 메시지 숨기기
						fetchNewReservations();
				}
		}

			let allReservations = []; // 모든 예약 데이터를 저장할 배열

			function fetchNewReservations() {
					$.ajax({
							url: '/member/reservation-list-ajax',
							type: 'GET',
							success: function(reservations) {
									allReservations = reservations; // 모든 데이터를 전역 변수에 저장
									renderReservationList(allReservations); // 초기 목록 렌더링
							}
					});
			}

			function renderReservationList(reservations) {
					const $list = $('#reservation-list');
					$list.empty();

					if (reservations.length === 0) {
							$list.html('<tr><td colspan="10">예약 내역이 없습니다.</td></tr>');
							return;
					}

					reservations.forEach(res => {
							const row = `
									<tr>
											<td>${res.lr_me_name}</td>
											<td>${res.lr_state}</td>
											<td>${res.lr_ld_name}</td>
											<td>${res.lr_rm_name}</td>
											<td>${formatDate(res.lr_checkin)} - ${formatDate(res.lr_checkout)}</td>
											<td>${res.lr_booker_name}(${res.lr_count})</td>
											<td>${res.lr_guest_name}</td>
											<td>${res.lr_total_price}</td>
											<td>${res.lr_total_price}</td>
											<td>${formatDateTime(res.lr_date)}</td>
									</tr>
							`;
							$list.append(row);
					});
			}

			function filterReservations() {
					const selectedState = $('#reservation-state').val();
					let filteredReservations;

					if (activeTab !== '호텔') return; // 호텔 탭이 아닐 때는 필터 무시

					if (selectedState === '전체') {
							filteredReservations = allReservations;
					} else if (selectedState === '예약완료') {
							filteredReservations = allReservations.filter(res => res.lr_state === '예약완료');
					} else if (selectedState === '취소/환불') {
							filteredReservations = allReservations.filter(res => res.lr_state === '예약취소');
					}

					renderReservationList(filteredReservations); // 필터링된 목록 렌더링
			}

			// 날짜 포맷 함수
			function formatDate(dateStr) {
					const date = new Date(dateStr);
					return date.toISOString().split('T')[0];
			}

			function formatDateTime(dateStr) {
					const date = new Date(dateStr);
					return date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0') + '-' +
							date.getDate().toString().padStart(2, '0') + ' ' +
							date.getHours().toString().padStart(2, '0') + ':' +
							date.getMinutes().toString().padStart(2, '0');
			}

			// 페이지 로드 시 최초 실행
			$(document).ready(function() {
					fetchNewReservations(); // 첫 로딩 시 호텔 예약 목록 가져오기
			});
		</script>
	</main>
</body>
</html>