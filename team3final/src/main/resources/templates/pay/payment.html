<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout.html}" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title>결제</title>
	<style>
		.main-container {
			background-color: #f5f6f7;
			font-family: 'Noto Sans KR', sans-serif;
		}

		.container-box {
			background-color: #fff;
			padding: 30px;
			border-radius: 10px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
			width: 100%;
			max-width: 100%;
		}

		h5 {
			font-size: 20px !important;
			font-weight: bold;
		}

		.row {
			max-width: 1032px;
			display: flex;
			justify-content: center;
			flex-wrap: nowrap;
			margin-top: 30px;
			margin-bottom: 150px;
		}

		.in {
			margin-top: 50px;
			margin-bottom: 10px;
		}

		.option-label {
			color: #333;
			font-size: 15px;
			font-weight: 400;
			margin-left: 6px;
			cursor: pointer;
			user-select: none;
		}

		.form-check {
			display: flex;
			align-items: center;
		}

		.form-check-input {
			width: 16px;
			height: 16px;
			margin-top: 0;
			margin-right: 0;
			transform: translateY(-4px);
			/*체크박스 위치조절*/
			cursor: pointer;
		}

		.form-check-input:checked+.option-label {
			color: #007BFF;
			font-weight: 500;
		}

		@media screen and (max-width:990px) {
			footer {
				display: none;
			}

			.row {
				flex-direction: column;
				align-items: center;
				padding: 0;
				margin: 0 auto;
			}

			.container-box {
				padding: 20px;
				margin-right: 0 !important;
				margin-bottom: 70px;
				margin-top: 10px;
				width: 100%;
				max-width: 640px;
			}

		}
	</style>
</head>

<body>
	<main layout:fragment="content" class="main-container">
		<div class="container mb-5">
			<!-- 왼쪽 데이터 시작-->
			<div class="row">
				<div class="col-md-7 container-box mr-3">
					<form>
						<small class="text-muted">[[${lodging.ld_rating}]]성급</small>
						<h5 class="d-flex justify-content-between align-items-center border-bottom pb-3 mt-1 mb-2"
							style="font-size: 20px" th:text="${lodging.ld_name}"></h5>
						<div class="d-flex justify-content-center align-items-center border-bottom pb-2" style="gap: 32px;">
							<div class="text-center mx-5">
								<small class="text-muted">체크인</small>
								<div style="font-weight: bold;" th:text="${checkIn}" class="check-in"></div>
								<div style="font-size: 0.9rem;">15:00 ~</div>
							</div>
							<div class="text-center mx-5">
								<span class="badge badge-light night">1박</span>
							</div>
							<div class="text-center mx-5">
								<small class="text-muted">체크아웃</small>
								<div style="font-weight: bold;" th:text="${checkOut}"  class="check-out"></div>
								<div style="font-size: 0.9rem;">11:00 까지</div>
							</div>
						</div>
						<div class="d-flex align-items-center border-bottom py-3">
							<div style="font-weight: bold; margin-right: 100px;">객실정보</div>
							<div>Deluxe Double City</div>
						</div>
						<div class="d-flex align-items-center pt-3">
							<div style="font-weight: bold; margin-right: 128px;">인원</div>
							<div>[[${rm_person}]]명</div>
						</div>
					</form>
					<form id="reservationForm">
						<h5 class="in">예약자 정보</h5>
						<div class="form-group">
							<label>이름</label>
							<input type="text" name="reserverName" class="form-control" placeholder="성명">
							<div class="invalid-feedback">이름을 정확히 입력해주세요.</div>
						</div>
						<div class="form-group">
							<label>휴대폰 번호</label>
							<input type="text" name="reserverPhone" class="form-control" placeholder="예: 010-1234-5678">
							<div class="invalid-feedback">형식에 맞는 휴대폰 번호를 입력해주세요.</div>
						</div>
						<h5 class="in">숙박자 정보</h5>
						<div class="form-check my-3">
							<input class="form-check-input" type="checkbox" id="sameInfo" checked>
							<label class="option-label" for="sameInfo">숙박자와 예약자 정보가 같습니다</label>
						</div>
						<div class="form-group">
							<label>이름</label>
							<input type="text" name="guestName" class="form-control" placeholder="성명">
							<div class="invalid-feedback">이름을 정확히 입력해주세요.</div>
						</div>
						<div class="form-group">
							<label>휴대폰 번호</label>
							<input type="text" name="guestPhone" class="form-control" placeholder="예: 010-1234-5678">
							<div class="invalid-feedback">형식에 맞는 휴대폰 번호를 입력해주세요.</div>
						</div>
					</form>
					<!-- 호텔 요청사항 쪽-->
					<form>
						<h5 class="mt-5 mb-3">호텔 요청사항</h5>
						<div class="d-flex flex-wrap">
							<div class="form-check mb-2" style="width: 50%;">
								<input class="form-check-input" type="checkbox" id="opt1">
								<label class="option-label" for="opt1">옵션 1</label>
							</div>
							<div class="form-check mb-2" style="width: 50%;">
								<input class="form-check-input" type="checkbox" id="opt2">
								<label class="option-label" for="opt2">옵션 2</label>
							</div>
							<div class="form-check mb-2" style="width: 50%;">
								<input class="form-check-input" type="checkbox" id="opt3">
								<label class="option-label" for="opt3">옵션 3</label>
							</div>
							<div class="form-check mb-2" style="width: 50%;">
								<input class="form-check-input" type="checkbox" id="opt4">
								<label class="option-label" for="opt4">옵션 4</label>
							</div>
							<div class="form-check mb-2" style="width: 50%;">
								<input class="form-check-input" type="checkbox" id="opt5">
								<label class="option-label" for="opt5">옵션 5</label>
							</div>
							<div class="form-check mb-2" style="width: 50%;">
								<input class="form-check-input" type="checkbox" id="opt6">
								<label class="option-label" for="opt6">옵션 6</label>
							</div>
						</div>
					</form>
					<!-- 호텔 요청사항 쪽 끝-->
					<form>
						<div class="mt-5">
							<h5 class="mb-4">객실 정보 안내</h5>
							<div class="d-flex border rounded p-3 mb-4" style="background-color: #fafafa;">
								<div class="w-50 text-center border-right">
									<div class="text-muted mb-1">체크인</div>
									<div style="font-weight: 500; color: #4564b8d2;">15:00 ~ 자정</div>
								</div>
								<div class="w-50 text-center">
									<div class="text-muted mb-1">체크아웃</div>
									<div style="font-weight: 500; color: #4564b8d2;">11:00 까지</div>
								</div>
							</div>
							<div class="mb-3">
								<strong>주요 안내사항</strong>
								<div class="mt-2 text-muted" style="
									font-size: 0.95rem;
									line-height: 1.5;
									white-space: pre-line;
									word-break: keep-all;
								">이곳은 DB에서 가져온 안내사항 문자열이 들어갈 자리입니다.
									• 추가 인원에 대한 요금이 부과될 수 있으며..
									• 체크인 시 신분증과 보증금이 필요할 수 있습니다.
								</div>
							</div>
						</div>
					</form>
					<form>
						<h5 class="mb-4 mt-5">결제 정보</h5>
						<!-- 총 상품금액 -->
						<div class="d-flex justify-content-between mb-2" style="cursor: pointer;" onclick="toggleDetailAll()">
							<div class="text-muted">총 상품금액</div>
							<div class="d-flex align-items-center" style="gap: 4px;">
								<div style="font-weight: bold;">66,000원</div>
								<img class="arrowImg" src="/resources/static/imgs/small-up.png" width="16" height="16" />
							</div>
						</div>
						<!-- 호텔 숙박 요금 -->
						<div class="priceDetail" style="display: none; font-size: 13px;">
							<div class="d-flex justify-content-between bg-light p-2 rounded mb-1">
								<div class="text-muted">1박 숙박 요금</div>
								<div class="text-muted">33,000원</div>
							</div>
						</div>
						<hr>
						<!-- 총 결제금액 -->
						<div class="d-flex justify-content-between mt-3">
							<strong>총 결제금액</strong>
							<strong>66,000원</strong>
						</div>
					</form>
				</div>
				<!-- 왼쪽 데이터 끝-->
				<div class="col-md-5" id="payment-summary-container" style="position: relative; overflow: visible;">
					<!-- Ajax로 불러온 내용이 여기에 들어옴 -->
				</div>
			</div>
		</div>
		<script>
			$(document).ready(function () {
				// 날짜 텍스트 가져오기
				const checkInText = $('.check-in').text().trim();   // 예: "5/23/금"
				const checkOutText = $('.check-out').text().trim(); // 예: "5/24/토"

				// 날짜 포맷에서 숫자만 추출
				const parseDate = (text) => {
					const parts = text.split('/'); // ["5", "23", "금"]
					const month = parseInt(parts[0]);
					const day = parseInt(parts[1]);
					const year = new Date().getFullYear(); // 연도는 현재 연도로 가정
					return new Date(year, month - 1, day); // JavaScript는 월이 0부터 시작
				};

				const checkInDate = parseDate(checkInText);
				const checkOutDate = parseDate(checkOutText);

				// 날짜 차이 계산
				const diffTime = checkOutDate - checkInDate;
				const diffDays = diffTime / (1000 * 60 * 60 * 24); // ms → days

				// .badge 안에 텍스트로 n박 입력
				$('.night').text(`${diffDays}박`);
			});



			let detailVisible = true;
			let isSyncing = false;

			function toggleDetailAll() {
				const $details = $(".priceDetail");
				const $arrows = $(".arrowImg");

				detailVisible = !detailVisible;

				if (detailVisible) {
					$details.stop(true, true).slideDown(200);
					$arrows.attr("src", "/resources/static/imgs/small-up.png");
				} else {
					$details.stop(true, true).slideUp(200);
					$arrows.attr("src", "/resources/static/imgs/small-down.png");
				}
			};

			function copyReserverToGuest() {
				isSyncing = true;
				const name = $("input[name='reserverName']").val();
				const phone = $("input[name='reserverPhone']").val();
				$("input[name='guestName']").val(name).trigger("input");
				$("input[name='guestPhone']").val(phone).trigger("input");
				isSyncing = false;
			}

			$(document).ready(function () {
				$(".priceDetail").hide();
				$(".arrowImg").attr("src", "/resources/static/imgs/small-down.png");

				$.ajax({
					url: '/pay/summary',
					type: 'GET',
					success: function (data) {
						$('#payment-summary-container').html(data);
						$(".priceDetail").slideDown(0);
						$(".arrowImg").attr("src", "/resources/static/imgs/small-up.png");
					},
					error: function (xhr) {
						console.error("요청 실패", xhr);
					}
				});

				// 기본값 복사 (초기 로딩 시)
				if ($("#sameInfo").is(":checked")) {
					copyReserverToGuest();
				}

				let prevChecked = $("#sameInfo").is(":checked");

				$("#sameInfo").on("click", function () {
					const isCheckedNow = $(this).is(":checked");

					if (!isCheckedNow && prevChecked) {
						// 직접 클릭으로 해제한 경우만 초기화
						$("input[name='guestName']").val("");
						$("input[name='guestPhone']").val("");
					}

					prevChecked = isCheckedNow;

					if (isCheckedNow) {
						copyReserverToGuest();
					}
				});

				// 예약자 입력 변경 시 → 동기화
				$("input[name='reserverName'], input[name='reserverPhone']").on("input", function () {
					if ($("#sameInfo").is(":checked")) {
						copyReserverToGuest();
					}
				});

				// 숙박자 직접 입력 시 → 체크 해제
				$("input[name='guestName'], input[name='guestPhone']").on("input", function () {
					if (isSyncing) return;
					if ($("#sameInfo").is(":checked")) {
						guestModified = true;
						$("#sameInfo").prop("checked", false).trigger("change");
					}
				});

				// 예약자 이름
				$("[name='reserverName']").on("input", function () {
					const nameRegex = /^[가-힣a-zA-Z]{2,20}$/;
					if (!nameRegex.test($(this).val().trim())) {
						$(this).addClass("is-invalid");
					} else {
						$(this).removeClass("is-invalid");
					}
				});

				// 숙박자 이름 (체크박스 체크 시 스킵)
				$("[name='guestName']").on("input", function () {
					const nameRegex = /^[가-힣a-zA-Z]{2,20}$/;
					if ($("#sameInfo").is(":checked")) {
						$(this).removeClass("is-invalid");
						return;
					}
					if (!nameRegex.test($(this).val().trim())) {
						$(this).addClass("is-invalid");
					} else {
						$(this).removeClass("is-invalid");
					}
				});

				// 예약자 전화번호
				$("input[name='reserverPhone']").on("input", function () {
					const phoneRegex = /^01[016789]-\d{3,4}-\d{4}$/;
					if (!phoneRegex.test($(this).val().trim())) {
						$(this).addClass("is-invalid");
					} else {
						$(this).removeClass("is-invalid");
					}
				});

				// 숙박자 전화번호
				$("input[name='guestPhone']").on("input", function () {
					const phoneRegex = /^01[016789]-\d{3,4}-\d{4}$/;
					if ($("#sameInfo").is(":checked")) {
						$(this).removeClass("is-invalid");
						return;
					}
					if (!phoneRegex.test($(this).val().trim())) {
						$(this).addClass("is-invalid");
					} else {
						$(this).removeClass("is-invalid");
					}
				});
			});
		</script>
	</main>
</body>

</html>